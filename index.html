<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sistem Manajemen Santri - GitHub</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ========== CSS SAMA PERSIS DENGAN ASLI ========== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #059669; --primary-dark: #047857; --primary-light: #10b981;
      --secondary: #1e293b; --accent: #f59e0b; --danger: #ef4444;
      --success: #10b981; --warning: #f59e0b; --info: #3b82f6;
      --background: #f8fafc; --surface: #ffffff; --text-primary: #1e293b;
      --text-secondary: #64748b; --border: #e2e8f0;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    body { font-family: 'Inter', sans-serif; background: var(--background); color: var(--text-primary); line-height: 1.6; min-height: 100vh; }
    .app-container { max-width: 1400px; margin: 0 auto; padding: 1rem; min-height: 100vh; }
    .login-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); padding: 1rem; }
    .login-card { background: var(--surface); padding: 2.5rem; border-radius: 1.5rem; box-shadow: var(--shadow-lg); width: 100%; max-width: 400px; text-align: center; }
    .login-logo { width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 2.5rem; color: white; }
    .login-title { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem; }
    .login-subtitle { color: var(--text-secondary); margin-bottom: 2rem; }
    .form-group { margin-bottom: 1.25rem; text-align: left; }
    .form-label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-primary); font-size: 0.875rem; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 0.875rem 1rem; border: 2px solid var(--border); border-radius: 0.75rem; font-size: 1rem; transition: all 0.2s; font-family: inherit; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.875rem 1.75rem; border: none; border-radius: 0.75rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; width: 100%; font-family: inherit; }
    .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text-primary); }
    .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
    .main-app { display: none; }
    .main-app.active { display: block; }
    .app-header { background: var(--surface); padding: 1rem 1.5rem; border-radius: 1rem; box-shadow: var(--shadow); margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
    .app-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
    .user-info { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; background: var(--background); border-radius: 0.75rem; }
    .user-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
    .nav-tabs { display: flex; gap: 0.5rem; background: var(--surface); padding: 0.5rem; border-radius: 1rem; box-shadow: var(--shadow); margin-bottom: 1.5rem; overflow-x: auto; }
    .nav-tab { padding: 0.75rem 1.25rem; border: none; background: transparent; border-radius: 0.75rem; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 0.5rem; }
    .nav-tab.active { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
    .card { background: var(--surface); border-radius: 1rem; box-shadow: var(--shadow); padding: 1.5rem; margin-bottom: 1.5rem; }
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border); flex-wrap: wrap; gap: 1rem; }
    .card-title { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 0.75rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { background: var(--surface); padding: 1.25rem; border-radius: 1rem; box-shadow: var(--shadow); text-align: center; }
    .stat-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.75rem; font-size: 1.5rem; }
    .stat-value { font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem; }
    .stat-label { font-size: 0.875rem; color: var(--text-secondary); font-weight: 500; }
    .table-responsive { overflow-x: auto; border-radius: 0.75rem; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .data-table th, .data-table td { padding: 0.875rem 1rem; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; }
    .data-table th { font-weight: 600; color: var(--text-primary); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
    .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600; }
    .badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    .badge-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
    .badge-info { background: rgba(59, 130, 246, 0.1); color: var(--info); }
    .autocomplete-wrapper { position: relative; }
    .autocomplete-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: var(--surface); border: 2px solid var(--border); border-top: none; border-radius: 0 0 0.75rem 0.75rem; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
    .autocomplete-suggestions.active { display: block; }
    .autocomplete-item { padding: 0.75rem 1rem; cursor: pointer; }
    .autocomplete-item:hover { background: var(--background); }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--surface); border-radius: 1.5rem; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); }
    .modal-header { padding: 1.5rem; border-bottom: 2px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 1.25rem; font-weight: 700; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
    .modal-body { padding: 1.5rem; }
    .modal-footer { padding: 1.5rem; border-top: 2px solid var(--border); display: flex; gap: 0.75rem; justify-content: flex-end; }
    .action-buttons { display: flex; gap: 0.5rem; }
    .action-btn { padding: 0.5rem; border: none; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; }
    .action-btn.edit { background: var(--info); color: white; }
    .action-btn.delete { background: var(--danger); color: white; }
    .loading { display: none; align-items: center; justify-content: center; padding: 2rem; }
    .loading.active { display: flex; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .alert { padding: 1rem 1.25rem; border-radius: 0.75rem; margin-bottom: 1rem; display: none; }
    .alert.active { display: block; }
    .alert-success { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid var(--success); }
    .alert-error { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
    .alert-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); border: 1px solid var(--warning); }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; background: var(--surface); border-radius: 0.75rem; box-shadow: var(--shadow-lg); display: none; z-index: 2000; max-width: 300px; }
    .toast.active { display: block; animation: toastSlideIn 0.3s ease; }
    .toast-success { border-left: 4px solid var(--success); }
    .toast-error { border-left: 4px solid var(--danger); }
    .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); }
    .attendance-buttons { display: flex; gap: 0.5rem; }
    .attendance-btn { flex: 1; padding: 0.5rem; border: 2px solid var(--border); border-radius: 0.5rem; background: white; cursor: pointer; font-weight: 600; }
    .attendance-btn.active { border-color: var(--primary); background: var(--primary); color: white; }
    .status-badge { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; font-weight: 700; font-size: 0.75rem; cursor: pointer; }
    .status-badge.H { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 2px solid var(--success); }
    .status-badge.I { background: rgba(59, 130, 246, 0.2); color: var(--info); border: 2px solid var(--info); }
    .status-badge.S { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 2px solid var(--warning); }
    .status-badge.A { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 2px solid var(--danger); }
    .status-badge.empty { background: #f1f5f9; color: #94a3b8; border: 1px solid var(--border); }
    @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div class="login-page" id="loginPage">
    <div class="login-card">
      <div class="login-logo"><i class="fas fa-mosque"></i></div>
      <h1 class="login-title">Sistem Manajemen Santri</h1>
      <p class="login-subtitle">Masuk untuk melanjutkan</p>
      <div id="loginAlert" class="alert"></div>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label">Username</label>
          <input type="text" class="form-input" id="loginUsername" placeholder="Masukkan username" required>
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="loginPassword" placeholder="Masukkan password" required>
        </div>
        <button type="submit" class="btn btn-primary" id="loginBtn">
          <i class="fas fa-sign-in-alt"></i> Masuk
        </button>
      </form>
      <p style="margin-top: 1.5rem; font-size: 0.875rem; color: var(--text-secondary);">Default: admin / santri123</p>
    </div>
  </div>

  <!-- Main Application -->
  <div class="main-app" id="mainApp">
    <div class="app-container">
      <header class="app-header">
        <div class="app-header-left">
          <div class="app-title"><i class="fas fa-mosque" style="color: var(--primary);"></i> Sistem Santri</div>
          <div class="app-subtitle">Manajemen Hafalan & Pelanggaran</div>
        </div>
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">A</div>
          <div>
            <div style="font-weight: 600;" id="userName">Administrator</div>
            <div style="font-size: 0.75rem; color: var(--text-secondary);">Admin</div>
          </div>
          <button class="action-btn delete" onclick="logout()" style="margin-left: 0.5rem;">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </header>

      <!-- Navigation -->
      <nav class="nav-tabs">
        <button class="nav-tab active" onclick="showPage('dashboard')"><i class="fas fa-home"></i> Dashboard</button>
        <button class="nav-tab" onclick="showPage('absensi')"><i class="fas fa-clipboard-check"></i> Absensi</button>
        <button class="nav-tab" onclick="showPage('data-absensi')"><i class="fas fa-table"></i> Data Absensi</button>
        <button class="nav-tab" onclick="showPage('progres')"><i class="fas fa-book-quran"></i> Progres</button>
        <button class="nav-tab" onclick="showPage('pelanggaran')"><i class="fas fa-exclamation-circle"></i> Pelanggaran</button>
      </nav>

      <!-- Dashboard Page -->
      <section class="page" id="dashboardPage">
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-users"></i></div><div class="stat-value" id="statSantri">0</div><div class="stat-label">Total Santri</div></div>
          <div class="stat-card"><div class="stat-icon success"><i class="fas fa-book-quran"></i></div><div class="stat-value" id="statProgres">0</div><div class="stat-label">Total Progres</div></div>
          <div class="stat-card"><div class="stat-icon info"><i class="fas fa-calendar-check"></i></div><div class="stat-value" id="statAbsensi">0</div><div class="stat-label">Total Absensi</div></div>
          <div class="stat-card"><div class="stat-icon danger"><i class="fas fa-exclamation-triangle"></i></div><div class="stat-value" id="statPelanggaran">0</div><div class="stat-label">Total Pelanggaran</div></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-calendar-day"></i> Absensi Hari Ini <small style="font-size:0.875rem;">(Hanya Non-Hadir)</small></h2>
            <div style="font-size:0.875rem;" id="todayDate"></div>
          </div>
          <div class="table-responsive">
            <table class="data-table" id="absensiHariIniTable">
              <thead><tr><th>Nama Santri</th><th>Kelas</th><th>Status</th><th>Keterangan</th></tr></thead>
              <tbody id="absensiHariIniBody"></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h2 class="card-title"><i class="fas fa-clock"></i> Aktivitas Terbaru</h2></div>
          <div id="recentActivities"></div>
        </div>
      </section>

      <!-- Input Absensi Page -->
      <section class="page" id="absensiPage" style="display: none;">
        <div class="card">
          <div class="card-header"><h2 class="card-title"><i class="fas fa-plus-circle"></i> Input Absensi</h2></div>
          <div id="absensiAlert" class="alert"></div>
          <div class="form-group">
            <label class="form-label">Tanggal *</label>
            <input type="date" class="form-input" id="absensiTanggal" required onchange="checkAbsensiExists()">
          </div>
          <div class="form-group">
            <label class="form-label">Kelas *</label>
            <select class="form-select" id="absensiKelas" required onchange="loadSantriByKelas()">
              <option value="">Pilih kelas</option>
            </select>
          </div>
          <div id="absensiExistsWarning" class="alert alert-warning" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i> Peringatan: Absensi untuk tanggal ini sudah diinput sebagian. Anda tetap bisa mengupdate.
          </div>
          <div id="absensiSantriList" style="display: none;">
            <h3 style="margin-bottom:1rem; font-size:1rem;">Daftar Santri - <span id="absensiKelasLabel"></span></h3>
            <div id="absensiSantriItems"></div>
            <button type="button" class="btn btn-primary" onclick="saveAbsensi()" style="margin-top:1.5rem;">
              <i class="fas fa-save"></i> Simpan Absensi
            </button>
          </div>
        </div>
      </section>

      <!-- Data Absensi Page -->
      <section class="page" id="dataAbsensiPage" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-table"></i> Data Absensi</h2>
            <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
              <select class="form-select" id="viewAbsensiKelas" onchange="loadAbsensiBulanList()" style="width:auto;">
                <option value="">Pilih Kelas</option>
              </select>
              <select class="form-select" id="viewAbsensiBulan" onchange="loadAbsensiView()" style="width:auto;">
                <option value="">Pilih Bulan</option>
              </select>
              <button class="btn btn-sm btn-outline" onclick="loadAbsensiView()"><i class="fas fa-sync"></i> Refresh</button>
              <button class="btn btn-sm btn-primary" onclick="printAbsensi()"><i class="fas fa-print"></i> Cetak</button>
            </div>
          </div>
          <div id="absensiViewLoading" class="loading"><div class="spinner"></div></div>
          <div class="table-responsive">
            <table class="data-table absensi-table" id="absensiTable">
              <thead id="absensiTableHead"></thead>
              <tbody id="absensiTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Progres Page -->
      <section class="page" id="progresPage" style="display: none;">
        <div class="card">
          <div class="card-header"><h2 class="card-title"><i class="fas fa-plus-circle"></i> Input Progres Hafalan</h2></div>
          <div id="progresAlert" class="alert"></div>
          <form id="progresForm">
            <div class="form-group">
              <label class="form-label">Nama Santri *</label>
              <div class="autocomplete-wrapper">
                <input type="text" class="form-input" id="progresNama" placeholder="Ketik nama santri..." required>
                <div class="autocomplete-suggestions" id="progresNamaSuggestions"></div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Tipe Hafalan *</label>
              <select class="form-select" id="progresTipe" required onchange="handleProgresTipeChange()">
                <option value="">Pilih tipe hafalan</option>
                <option value="Surat Wajib">Surat Wajib</option>
                <option value="Kitab">Kitab</option>
                <option value="Fasholatan">Fasholatan</option>
                <option value="Lainnya">Lainnya</option>
              </select>
            </div>
            <div id="suratWajibFields" style="display: none;">
              <div class="form-group"><label class="form-label">Surah *</label><input type="text" class="form-input" id="progresSurah" placeholder="Nama surah"></div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                <div class="form-group"><label class="form-label">Dari Ayat</label><input type="number" class="form-input" id="progresDariAyat" placeholder="0" min="0"></div>
                <div class="form-group"><label class="form-label">Sampai Ayat</label><input type="number" class="form-input" id="progresSampaiAyat" placeholder="0" min="0"></div>
              </div>
            </div>
            <div id="kitabFields" style="display: none;">
              <div class="form-group"><label class="form-label">Nama Kitab *</label><input type="text" class="form-input" id="progresNamaKitab" placeholder="Nama kitab"></div>
              <div class="form-group"><label class="form-label">Jumlah Bait</label><input type="number" class="form-input" id="progresBait" placeholder="0" min="0"></div>
            </div>
            <div id="lainnyaFields" style="display: none;">
              <div class="form-group"><label class="form-label">Nama Progres *</label><input type="text" class="form-input" id="progresNamaLainnya" placeholder="Nama progres"></div>
            </div>
            <div class="form-group"><label class="form-label">Keterangan</label><textarea class="form-textarea" id="progresKeterangan" placeholder="Keterangan tambahan..."></textarea></div>
            <button type="submit" class="btn btn-primary" id="progresBtn"><i class="fas fa-save"></i> Simpan Progres</button>
          </form>
        </div>
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-list"></i> Data Progres Hafalan</h2>
            <div style="display:flex; gap:0.5rem;">
              <button class="btn btn-sm btn-outline" onclick="loadProgresData()"><i class="fas fa-sync"></i> Refresh</button>
              <button class="btn btn-sm btn-primary" onclick="printProgres()"><i class="fas fa-print"></i> Cetak</button>
            </div>
          </div>
          <div id="progresLoading" class="loading"><div class="spinner"></div></div>
          <div class="form-group"><input type="text" class="form-input" id="searchProgres" placeholder="Cari progres..." onkeyup="filterProgres()"></div>
          <div class="table-responsive">
            <table class="data-table" id="progresTable">
              <thead><tr><th>Tanggal</th><th>Nama Santri</th><th>Tipe</th><th>Detail</th><th>Editor</th><th>Aksi</th></tr></thead>
              <tbody id="progresTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Pelanggaran Page -->
      <section class="page" id="pelanggaranPage" style="display: none;">
        <div class="card">
          <div class="card-header"><h2 class="card-title"><i class="fas fa-plus-circle"></i> Input Pelanggaran</h2></div>
          <div id="pelanggaranAlert" class="alert"></div>
          <form id="pelanggaranForm">
            <div class="form-group">
              <label class="form-label">Nama Santri *</label>
              <div class="autocomplete-wrapper">
                <input type="text" class="form-input" id="pelanggaranNama" placeholder="Ketik nama santri..." required>
                <div class="autocomplete-suggestions" id="pelanggaranNamaSuggestions"></div>
              </div>
            </div>
            <div class="form-group"><label class="form-label">Pelanggaran *</label><input type="text" class="form-input" id="pelanggaranJenis" placeholder="Jenis pelanggaran" required></div>
            <div class="form-group"><label class="form-label">Keterangan</label><textarea class="form-textarea" id="pelanggaranKeterangan" placeholder="Keterangan tambahan..."></textarea></div>
            <button type="submit" class="btn btn-danger" id="pelanggaranBtn"><i class="fas fa-save"></i> Simpan Pelanggaran</button>
          </form>
        </div>
        <div class="card">
          <div class="card-header">
            <h2 class="card-title"><i class="fas fa-list"></i> Data Pelanggaran</h2>
            <div style="display:flex; gap:0.5rem;">
              <input type="text" class="form-input" id="searchPelanggaran" placeholder="Cari pelanggaran..." onkeyup="filterPelanggaran()" style="width:auto;">
              <button class="btn btn-sm btn-outline" onclick="loadPelanggaranData()"><i class="fas fa-sync"></i> Refresh</button>
              <button class="btn btn-sm btn-danger" onclick="printPelanggaran()"><i class="fas fa-print"></i> Cetak</button>
            </div>
          </div>
          <div id="pelanggaranLoading" class="loading"><div class="spinner"></div></div>
          <div class="table-responsive">
            <table class="data-table" id="pelanggaranTable">
              <thead><tr><th>Tanggal</th><th>Nama Santri</th><th>Pelanggaran</th><th>Keterangan</th><th>Editor</th><th>Aksi</th></tr></thead>
              <tbody id="pelanggaranTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal Edit Progres -->
  <div class="modal-overlay" id="editProgresModal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Edit Progres Hafalan</h3><button class="modal-close" onclick="closeEditProgresModal()">&times;</button></div>
      <div class="modal-body">
        <form id="editProgresForm">
          <input type="hidden" id="editProgresId">
          <div class="form-group">
            <label class="form-label">Nama Santri *</label>
            <div class="autocomplete-wrapper">
              <input type="text" class="form-input" id="editProgresNama" placeholder="Ketik nama santri..." required>
              <div class="autocomplete-suggestions" id="editProgresNamaSuggestions"></div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Tipe Hafalan *</label>
            <select class="form-select" id="editProgresTipe" required onchange="handleEditProgresTipeChange()">
              <option value="">Pilih tipe hafalan</option>
              <option value="Surat Wajib">Surat Wajib</option>
              <option value="Kitab">Kitab</option>
              <option value="Fasholatan">Fasholatan</option>
              <option value="Lainnya">Lainnya</option>
            </select>
          </div>
          <div id="editSuratWajibFields" style="display: none;">
            <div class="form-group"><label class="form-label">Surah *</label><input type="text" class="form-input" id="editProgresSurah" placeholder="Nama surah"></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
              <div class="form-group"><label class="form-label">Dari Ayat</label><input type="number" class="form-input" id="editProgresDariAyat" placeholder="0" min="0"></div>
              <div class="form-group"><label class="form-label">Sampai Ayat</label><input type="number" class="form-input" id="editProgresSampaiAyat" placeholder="0" min="0"></div>
            </div>
          </div>
          <div id="editKitabFields" style="display: none;">
            <div class="form-group"><label class="form-label">Nama Kitab *</label><input type="text" class="form-input" id="editProgresNamaKitab" placeholder="Nama kitab"></div>
            <div class="form-group"><label class="form-label">Jumlah Bait</label><input type="number" class="form-input" id="editProgresBait" placeholder="0" min="0"></div>
          </div>
          <div id="editLainnyaFields" style="display: none;">
            <div class="form-group"><label class="form-label">Nama Progres *</label><input type="text" class="form-input" id="editProgresNamaLainnya" placeholder="Nama progres"></div>
          </div>
          <div class="form-group"><label class="form-label">Keterangan</label><textarea class="form-textarea" id="editProgresKeterangan" placeholder="Keterangan tambahan..."></textarea></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeEditProgresModal()">Batal</button>
        <button class="btn btn-primary" onclick="saveEditProgres()">Simpan</button>
      </div>
    </div>
  </div>

  <!-- Modal Edit Pelanggaran -->
  <div class="modal-overlay" id="editPelanggaranModal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Edit Pelanggaran</h3><button class="modal-close" onclick="closeEditPelanggaranModal()">&times;</button></div>
      <div class="modal-body">
        <form id="editPelanggaranForm">
          <input type="hidden" id="editPelanggaranId">
          <div class="form-group">
            <label class="form-label">Nama Santri *</label>
            <div class="autocomplete-wrapper">
              <input type="text" class="form-input" id="editPelanggaranNama" placeholder="Ketik nama santri..." required>
              <div class="autocomplete-suggestions" id="editPelanggaranNamaSuggestions"></div>
            </div>
          </div>
          <div class="form-group"><label class="form-label">Pelanggaran *</label><input type="text" class="form-input" id="editPelanggaranJenis" placeholder="Jenis pelanggaran" required></div>
          <div class="form-group"><label class="form-label">Keterangan</label><textarea class="form-textarea" id="editPelanggaranKeterangan" placeholder="Keterangan tambahan..."></textarea></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeEditPelanggaranModal()">Batal</button>
        <button class="btn btn-danger" onclick="saveEditPelanggaran()">Simpan</button>
      </div>
    </div>
  </div>

  <!-- Modal Edit Absensi -->
  <div class="modal-overlay" id="editAbsensiModal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Edit Absensi</h3><button class="modal-close" onclick="closeEditAbsensiModal()">&times;</button></div>
      <div class="modal-body">
        <input type="hidden" id="editAbsensiKelas"><input type="hidden" id="editAbsensiBulan"><input type="hidden" id="editAbsensiTanggal"><input type="hidden" id="editAbsensiNamaSantri">
        <div class="form-group"><label class="form-label">Nama Santri</label><input type="text" class="form-input" id="editAbsensiNamaDisplay" readonly></div>
        <div class="form-group"><label class="form-label">Tanggal</label><input type="text" class="form-input" id="editAbsensiTanggalDisplay" readonly></div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <div class="attendance-buttons">
            <button type="button" class="attendance-btn H" id="editAbsensiBtnH" onclick="setEditAbsensiStatus('H')">H</button>
            <button type="button" class="attendance-btn I" id="editAbsensiBtnI" onclick="setEditAbsensiStatus('I')">I</button>
            <button type="button" class="attendance-btn S" id="editAbsensiBtnS" onclick="setEditAbsensiStatus('S')">S</button>
            <button type="button" class="attendance-btn A" id="editAbsensiBtnA" onclick="setEditAbsensiStatus('A')">A</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="deleteAbsensiCell()"><i class="fas fa-trash"></i> Hapus</button>
        <button class="btn btn-outline" onclick="closeEditAbsensiModal()">Batal</button>
        <button class="btn btn-primary" onclick="saveEditAbsensi()">Simpan</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ========== KONFIGURASI ==========
    // üîÅ GANTI DENGAN URL WEB APP ANDA HASIL DEPLOY
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxU9GN2yQ0d-etzODIO8fy5NRx0H3WND-hXmtKoPsrtgm63FkDuP8iyp4_UO1BoKyZB0A/exec'; // PASTE URL ANDA DI SINI

    // Helper fetch ke Apps Script - MENGGUNAKAN Content-Type: text/plain UNTUK MENGHINDARI PREFLIGHT
    async function callAppsScript(action, payload = {}) {
      const response = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'text/plain;charset=UTF-8' // ‚úÖ TIDAK MEMICU PREFLIGHT
        },
        body: JSON.stringify({ action, ...payload })
      });
      return await response.json();
    }

    // ========== GLOBAL VARIABLES ==========
    let currentUser = null;
    let santriData = [];
    let kelasData = [];
    let progresData = [];
    let pelanggaranData = [];
    let absensiHariIniData = [];
    let editAbsensiStatus = 'H';

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', function() {
      checkLogin();
      setupEventListeners();
      updateTodayDate();
    });

    function updateTodayDate() {
      const today = new Date();
      document.getElementById('todayDate').textContent = today.toLocaleDateString('id-ID', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
    }

    // ========== EVENT LISTENERS ==========
    function setupEventListeners() {
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      document.getElementById('progresForm').addEventListener('submit', handleProgresSubmit);
      document.getElementById('pelanggaranForm').addEventListener('submit', handlePelanggaranSubmit);
      setupAutocomplete('progresNama', 'progresNamaSuggestions');
      setupAutocomplete('pelanggaranNama', 'pelanggaranNamaSuggestions');
      setupAutocomplete('editProgresNama', 'editProgresNamaSuggestions');
      setupAutocomplete('editPelanggaranNama', 'editPelanggaranNamaSuggestions');
      document.getElementById('absensiTanggal').valueAsDate = new Date();
    }

    // ========== AUTHENTICATION ==========
    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const btn = document.getElementById('loginBtn');
      btn.disabled = true; btn.innerHTML = '<div class="spinner" style="width:20px; height:20px;"></div>';

      try {
        const result = await callAppsScript('login', { username, password });
        if (result.success) {
          currentUser = result;
          localStorage.setItem('currentUser', JSON.stringify(result));
          showMainApp();
          showToast('Login berhasil!', 'success');
        } else {
          showAlert('loginAlert', result.message, 'error');
        }
      } catch (err) {
        showAlert('loginAlert', 'Terjadi kesalahan: ' + err.message, 'error');
      } finally {
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Masuk';
      }
    }

    function checkLogin() {
      const saved = localStorage.getItem('currentUser');
      if (saved) {
        currentUser = JSON.parse(saved);
        showMainApp();
      }
    }

    function logout() {
      localStorage.removeItem('currentUser');
      currentUser = null;
      document.getElementById('mainApp').classList.remove('active');
      document.getElementById('loginPage').style.display = 'flex';
      showToast('Logout berhasil', 'info');
    }

    function showMainApp() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('mainApp').classList.add('active');
      document.getElementById('userName').textContent = currentUser?.name || 'Administrator';
      document.getElementById('userAvatar').textContent = (currentUser?.name || 'A').charAt(0).toUpperCase();
      showPage('dashboard');
      loadKelas();
      loadSantriData();
    }

    // ========== PAGE NAVIGATION ==========
    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

      let pageId = page + 'Page';
      if (page === 'data-absensi') pageId = 'dataAbsensiPage';
      const el = document.getElementById(pageId);
      if (el) el.style.display = 'block';

      const tabText = page.replace('-', ' ');
      document.querySelectorAll('.nav-tab').forEach(tab => {
        if (tab.textContent.toLowerCase().includes(tabText.toLowerCase())) tab.classList.add('active');
      });

      if (page === 'dashboard') loadDashboard();
      else if (page === 'absensi') loadAbsensiKelasForInput();
      else if (page === 'data-absensi') loadAbsensiKelasForData();
      else if (page === 'progres') loadProgresData();
      else if (page === 'pelanggaran') loadPelanggaranData();
    }

    // ========== DASHBOARD ==========
    async function loadDashboard() {
      try {
        const result = await callAppsScript('getDashboardStats');
        if (result.success) {
          const stats = result.data;
          document.getElementById('statSantri').textContent = stats.totalSantri;
          document.getElementById('statProgres').textContent = stats.totalProgres;
          document.getElementById('statAbsensi').textContent = stats.totalAbsensi;
          document.getElementById('statPelanggaran').textContent = stats.totalPelanggaran;
          renderAbsensiHariIni(stats.absensiHariIni);
          renderRecentActivities(stats.recentActivities);
        }
      } catch (e) {
        console.error('Dashboard error', e);
      }
    }

    function renderAbsensiHariIni(data) {
      const tbody = document.getElementById('absensiHariIniBody');
      absensiHariIniData = data || [];
      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:2rem;">Semua santri hadir hari ini</td></tr>`;
        return;
      }
      tbody.innerHTML = data.map(item => {
        let cls = 'badge-success', label = 'Hadir';
        if (item.status === 'I') { cls = 'badge-info'; label = 'Izin'; }
        else if (item.status === 'S') { cls = 'badge-warning'; label = 'Sakit'; }
        else if (item.status === 'A') { cls = 'badge-danger'; label = 'Alpa'; }
        return `<tr><td><strong>${item.namaSantri}</strong></td><td>${item.kelas}</td><td><span class="badge ${cls}">${label}</span></td><td>${item.keterangan || '-'}</td></tr>`;
      }).join('');
    }

    function renderRecentActivities(activities) {
      const container = document.getElementById('recentActivities');
      if (!activities || activities.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-history"></i></div><div>Belum ada aktivitas</div></div>`;
        return;
      }
      let html = '<div class="table-responsive"><table class="data-table"><tbody>';
      activities.forEach(a => {
        const date = new Date(a.tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        let icon = 'fa-calendar-check', badge = 'badge-info', label = 'Absensi', detail = a.kelas || '';
        if (a.type === 'progres') { badge = 'badge-success'; label = 'Progres'; detail = a.tipeHafalan; }
        else if (a.type === 'pelanggaran') { badge = 'badge-danger'; label = 'Pelanggaran'; detail = a.pelanggaran; }
        html += `<tr><td><span class="badge ${badge}">${label}</span></td><td><strong>${a.namaSantri}</strong></td><td>${detail}</td><td><small>${date}</small></td></tr>`;
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    // ========== KELAS ==========
    async function loadKelas() {
      const res = await callAppsScript('getKelasData');
      if (res.success) kelasData = res.data;
    }

    async function loadAbsensiKelasForInput() {
      const res = await callAppsScript('getKelasData');
      if (res.success) {
        const select = document.getElementById('absensiKelas');
        select.innerHTML = '<option value="">Pilih kelas</option>' + res.data.map(k => `<option value="${k.nama}">${k.nama}</option>`).join('');
      }
    }

    async function loadAbsensiKelasForData() {
      const res = await callAppsScript('getKelasData');
      if (res.success) {
        const select = document.getElementById('viewAbsensiKelas');
        select.innerHTML = '<option value="">Pilih Kelas</option>' + res.data.map(k => `<option value="${k.nama}">${k.nama}</option>`).join('');
      }
    }

    // ========== SANTRI ==========
    async function loadSantriData() {
      const res = await callAppsScript('getSantriData');
      if (res.success) santriData = res.data;
    }

    async function loadSantriByKelas() {
      const kelas = document.getElementById('absensiKelas').value;
      if (!kelas) { document.getElementById('absensiSantriList').style.display = 'none'; return; }
      const res = await callAppsScript('getSantriByKelas', { kelas });
      if (res.success) {
        const data = res.data;
        document.getElementById('absensiKelasLabel').textContent = kelas;
        const container = document.getElementById('absensiSantriItems');
        if (!data || data.length === 0) {
          container.innerHTML = '<div class="empty-state">Tidak ada santri di kelas ini</div>';
        } else {
          container.innerHTML = data.map(s => `
            <div style="background:var(--background); padding:1rem; border-radius:0.75rem; margin-bottom:0.75rem;">
              <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:0.5rem;">
                <strong>${s.nama}</strong>
                <div class="attendance-buttons">
                  <button type="button" class="attendance-btn H active" data-nama="${s.nama}" data-status="H" onclick="setAttendanceStatus(this)">H</button>
                  <button type="button" class="attendance-btn I" data-nama="${s.nama}" data-status="I" onclick="setAttendanceStatus(this)">I</button>
                  <button type="button" class="attendance-btn S" data-nama="${s.nama}" data-status="S" onclick="setAttendanceStatus(this)">S</button>
                  <button type="button" class="attendance-btn A" data-nama="${s.nama}" data-status="A" onclick="setAttendanceStatus(this)">A</button>
                </div>
              </div>
              <div style="margin-top:0.5rem;">
                <input type="text" class="form-input" id="keterangan-${s.nama.replace(/\s+/g, '-')}" placeholder="Keterangan..." style="font-size:0.875rem;">
              </div>
            </div>
          `).join('');
        }
        document.getElementById('absensiSantriList').style.display = 'block';
      }
    }

    function setAttendanceStatus(btn) {
      const nama = btn.dataset.nama;
      document.querySelectorAll(`.attendance-buttons button[data-nama="${nama}"]`).forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    // ========== ABSENSI ==========
    async function checkAbsensiExists() {
      const tanggal = document.getElementById('absensiTanggal').value;
      const kelas = document.getElementById('absensiKelas').value;
      if (!tanggal || !kelas) return;
      const dateObj = new Date(tanggal);
      const bulan = getBulanName(dateObj.getMonth() + 1);
      const tanggalNum = dateObj.getDate();
      const res = await callAppsScript('checkAbsensiExists', { kelas, bulan, tanggal: tanggalNum, namaSantri: '' });
      if (res.success) {
        document.getElementById('absensiExistsWarning').style.display = res.exists ? 'block' : 'none';
      }
    }

    async function saveAbsensi() {
      const tanggal = document.getElementById('absensiTanggal').value;
      const kelas = document.getElementById('absensiKelas').value;
      if (!tanggal || !kelas) { showToast('Pilih tanggal dan kelas', 'error'); return; }
      const santriItems = document.querySelectorAll('#absensiSantriItems > div');
      const santriInputData = [];
      santriItems.forEach(item => {
        const nama = item.querySelector('strong').textContent;
        const statusBtn = item.querySelector('.attendance-btn.active');
        const status = statusBtn ? statusBtn.dataset.status : 'H';
        const keterangan = item.querySelector('input[type="text"]')?.value.trim() || '';
        santriInputData.push({ nama, status, keterangan });
      });
      if (santriInputData.length === 0) return;
      const res = await callAppsScript('addAbsensi', {
        data: {
          tanggal, kelas,
          santri: santriInputData,
          editor: currentUser?.name || 'Admin'
        }
      });
      if (res.success) {
        showToast(res.message, 'success');
        document.getElementById('absensiSantriItems').innerHTML = '';
        document.getElementById('absensiSantriList').style.display = 'none';
        loadDashboard();
      } else {
        showToast(res.message, 'error');
      }
    }

    async function loadAbsensiBulanList() {
      const kelas = document.getElementById('viewAbsensiKelas').value;
      if (!kelas) { document.getElementById('viewAbsensiBulan').innerHTML = '<option value="">Pilih Bulan</option>'; return; }
      document.getElementById('absensiViewLoading').classList.add('active');
      const res = await callAppsScript('getAbsensiBulan', { kelas });
      document.getElementById('absensiViewLoading').classList.remove('active');
      if (res.success) {
        const select = document.getElementById('viewAbsensiBulan');
        select.innerHTML = '<option value="">Pilih Bulan</option>' + res.data.map(b => `<option value="${b.nama}">${b.nama}</option>`).join('');
      }
    }

    async function loadAbsensiView() {
      const kelas = document.getElementById('viewAbsensiKelas').value;
      const bulan = document.getElementById('viewAbsensiBulan').value;
      if (!kelas || !bulan) return;
      document.getElementById('absensiViewLoading').classList.add('active');
      const res = await callAppsScript('getAbsensiData', { filter: { kelas, bulan } });
      document.getElementById('absensiViewLoading').classList.remove('active');
      if (res.success) renderAbsensiTable(res.data, bulan);
    }

    function renderAbsensiTable(data, bulan) {
      const thead = document.getElementById('absensiTableHead');
      const tbody = document.getElementById('absensiTableBody');
      if (!data || data.length === 0) {
        thead.innerHTML = '';
        tbody.innerHTML = '<tr><td colspan="33" style="text-align:center;"><div class="empty-state">Belum ada data absensi</div></td></tr>';
        return;
      }
      let headerHtml = '<tr><th rowspan="2" style="text-align:left;">Nama Santri</th><th colspan="31" style="text-align:center;">Tanggal</th><th rowspan="2">Keterangan</th></tr><tr>';
      for (let i = 1; i <= 31; i++) headerHtml += `<th class="status-cell">${i}</th>`;
      headerHtml += '<th>&nbsp;</th></tr>';
      thead.innerHTML = headerHtml;

      let bodyHtml = '';
      data.forEach(item => {
        bodyHtml += '<tr><th class="nama-cell">' + item.namaSantri + '</th>';
        for (let i = 1; i <= 31; i++) {
          const status = item.tanggal[i] || '';
          bodyHtml += `<td class="status-cell" onclick="openEditAbsensiModal('${item.namaSantri}', ${i}, '${status}')" style="cursor:pointer;">`;
          bodyHtml += status ? `<span class="status-badge ${status}">${status}</span>` : `<span class="status-badge empty">-</span>`;
          bodyHtml += '</td>';
        }
        bodyHtml += `<td class="keterangan-cell">${item.keterangan || '-'}</td></tr>`;
      });
      tbody.innerHTML = bodyHtml;
    }

    function openEditAbsensiModal(nama, tanggal, status) {
      document.getElementById('editAbsensiNamaSantri').value = nama;
      document.getElementById('editAbsensiNamaDisplay').value = nama;
      document.getElementById('editAbsensiKelas').value = document.getElementById('viewAbsensiKelas').value;
      document.getElementById('editAbsensiBulan').value = document.getElementById('viewAbsensiBulan').value;
      document.getElementById('editAbsensiTanggal').value = tanggal;
      document.getElementById('editAbsensiTanggalDisplay').value = `${tanggal} ${document.getElementById('viewAbsensiBulan').value}`;
      setEditAbsensiStatus(status || 'H');
      document.getElementById('editAbsensiModal').classList.add('active');
    }

    function closeEditAbsensiModal() { document.getElementById('editAbsensiModal').classList.remove('active'); }
    function setEditAbsensiStatus(s) {
      editAbsensiStatus = s;
      ['H','I','S','A'].forEach(st => document.getElementById('editAbsensiBtn'+st).classList.remove('active'));
      document.getElementById('editAbsensiBtn'+s).classList.add('active');
    }

    async function saveEditAbsensi() {
      const data = {
        kelas: document.getElementById('editAbsensiKelas').value,
        bulan: document.getElementById('editAbsensiBulan').value,
        tanggal: document.getElementById('editAbsensiTanggal').value,
        namaSantri: document.getElementById('editAbsensiNamaSantri').value,
        status: editAbsensiStatus
      };
      const res = await callAppsScript('updateAbsensi', { id: '', data });
      if (res.success) { closeEditAbsensiModal(); showToast(res.message, 'success'); loadAbsensiView(); }
      else showToast(res.message, 'error');
    }

    async function deleteAbsensiCell() {
      if (!confirm('Hapus absensi ini?')) return;
      const data = {
        kelas: document.getElementById('editAbsensiKelas').value,
        bulan: document.getElementById('editAbsensiBulan').value,
        tanggal: document.getElementById('editAbsensiTanggal').value,
        namaSantri: document.getElementById('editAbsensiNamaSantri').value
      };
      const res = await callAppsScript('deleteAbsensi', { data });
      if (res.success) { closeEditAbsensiModal(); showToast(res.message, 'success'); loadAbsensiView(); }
      else showToast(res.message, 'error');
    }

    // ========== PROGRES ==========
    function handleProgresTipeChange() {
      const t = document.getElementById('progresTipe').value;
      document.getElementById('suratWajibFields').style.display = t === 'Surat Wajib' ? 'block' : 'none';
      document.getElementById('kitabFields').style.display = t === 'Kitab' ? 'block' : 'none';
      document.getElementById('lainnyaFields').style.display = t === 'Lainnya' ? 'block' : 'none';
    }

    async function handleProgresSubmit(e) {
      e.preventDefault();
      const nama = document.getElementById('progresNama').value.trim();
      const tipe = document.getElementById('progresTipe').value;
      if (!nama || !tipe) { showToast('Lengkapi field wajib', 'error'); return; }
      const btn = document.getElementById('progresBtn');
      btn.disabled = true; btn.innerHTML = '<div class="spinner" style="width:20px; height:20px;"></div>';
      const data = {
        namaSantri: nama,
        tipeHafalan: tipe,
        keterangan: document.getElementById('progresKeterangan').value.trim(),
        editor: currentUser?.name
      };
      if (tipe === 'Surat Wajib') {
        data.surah = document.getElementById('progresSurah').value.trim();
        data.dariAyat = document.getElementById('progresDariAyat').value;
        data.sampaiAyat = document.getElementById('progresSampaiAyat').value;
      } else if (tipe === 'Kitab') {
        data.surah = document.getElementById('progresNamaKitab').value.trim();
        data.bait = document.getElementById('progresBait').value;
      } else if (tipe === 'Lainnya') {
        data.surah = document.getElementById('progresNamaLainnya').value.trim();
      } else data.surah = '-';
      const res = await callAppsScript('addProgres', { data });
      if (res.success) {
        document.getElementById('progresForm').reset();
        handleProgresTipeChange();
        showToast(res.message, 'success');
        loadProgresData();
      } else showToast(res.message, 'error');
      btn.disabled = false; btn.innerHTML = '<i class="fas fa-save"></i> Simpan Progres';
    }

    async function loadProgresData() {
      document.getElementById('progresLoading').classList.add('active');
      const res = await callAppsScript('getProgresData', { filter: {} });
      document.getElementById('progresLoading').classList.remove('active');
      if (res.success) {
        progresData = res.data;
        renderProgresTable(progresData);
      }
    }

    function renderProgresTable(data) {
      const tbody = document.getElementById('progresTableBody');
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;"><div class="empty-state">Belum ada data progres</div></td></tr>';
        return;
      }
      tbody.innerHTML = data.map(p => {
        const d = new Date(p.tanggal).toLocaleDateString('id-ID');
        let detail = '';
        if (p.tipeHafalan === 'Surat Wajib') detail = `${p.surah} (${p.dariAyat||0} - ${p.sampaiAyat||0})`;
        else if (p.tipeHafalan === 'Kitab') detail = `${p.surah} (${p.bait||0} bait)`;
        else detail = p.surah || '-';
        return `<tr>
          <td>${d}</td>
          <td><strong>${p.namaSantri}</strong></td>
          <td><span class="badge badge-info">${p.tipeHafalan}</span></td>
          <td>${detail}</td>
          <td>${p.editor}</td>
          <td><div class="action-buttons">
            <button class="action-btn edit" onclick="openEditProgresModal('${p.id}')"><i class="fas fa-edit"></i></button>
            <button class="action-btn delete" onclick="deleteProgres('${p.id}')"><i class="fas fa-trash"></i></button>
          </div></td>
        </tr>`;
      }).join('');
    }

    function filterProgres() {
      const kw = document.getElementById('searchProgres').value.toLowerCase();
      const filtered = progresData.filter(p => p.namaSantri.toLowerCase().includes(kw) || p.tipeHafalan.toLowerCase().includes(kw));
      renderProgresTable(filtered);
    }

    function openEditProgresModal(id) {
      const p = progresData.find(x => x.id === id);
      if (!p) return;
      document.getElementById('editProgresId').value = p.id;
      document.getElementById('editProgresNama').value = p.namaSantri;
      document.getElementById('editProgresTipe').value = p.tipeHafalan;
      document.getElementById('editProgresKeterangan').value = p.keterangan || '';
      handleEditProgresTipeChange();
      if (p.tipeHafalan === 'Surat Wajib') {
        document.getElementById('editProgresSurah').value = p.surah || '';
        document.getElementById('editProgresDariAyat').value = p.dariAyat || '';
        document.getElementById('editProgresSampaiAyat').value = p.sampaiAyat || '';
      } else if (p.tipeHafalan === 'Kitab') {
        document.getElementById('editProgresNamaKitab').value = p.surah || '';
        document.getElementById('editProgresBait').value = p.bait || '';
      } else {
        document.getElementById('editProgresNamaLainnya').value = p.surah || '';
      }
      document.getElementById('editProgresModal').classList.add('active');
    }

    function closeEditProgresModal() { document.getElementById('editProgresModal').classList.remove('active'); }
    function handleEditProgresTipeChange() {
      const t = document.getElementById('editProgresTipe').value;
      document.getElementById('editSuratWajibFields').style.display = t === 'Surat Wajib' ? 'block' : 'none';
      document.getElementById('editKitabFields').style.display = t === 'Kitab' ? 'block' : 'none';
      document.getElementById('editLainnyaFields').style.display = t === 'Lainnya' ? 'block' : 'none';
    }

    async function saveEditProgres() {
      const id = document.getElementById('editProgresId').value;
      const nama = document.getElementById('editProgresNama').value.trim();
      const tipe = document.getElementById('editProgresTipe').value;
      if (!nama || !tipe) { showToast('Lengkapi data', 'error'); return; }
      const data = {
        namaSantri: nama,
        tipeHafalan: tipe,
        keterangan: document.getElementById('editProgresKeterangan').value.trim(),
        editor: currentUser?.name
      };
      if (tipe === 'Surat Wajib') {
        data.surah = document.getElementById('editProgresSurah').value.trim();
        data.dariAyat = document.getElementById('editProgresDariAyat').value;
        data.sampaiAyat = document.getElementById('editProgresSampaiAyat').value;
      } else if (tipe === 'Kitab') {
        data.surah = document.getElementById('editProgresNamaKitab').value.trim();
        data.bait = document.getElementById('editProgresBait').value;
      } else if (tipe === 'Lainnya') {
        data.surah = document.getElementById('editProgresNamaLainnya').value.trim();
      } else data.surah = '-';
      const res = await callAppsScript('updateProgres', { id, data });
      if (res.success) { closeEditProgresModal(); showToast(res.message, 'success'); loadProgresData(); }
      else showToast(res.message, 'error');
    }

    async function deleteProgres(id) {
      if (!confirm('Hapus progres ini?')) return;
      const res = await callAppsScript('deleteProgres', { id });
      if (res.success) { showToast(res.message, 'success'); loadProgresData(); }
      else showToast(res.message, 'error');
    }

    // ========== PELANGGARAN ==========
    async function handlePelanggaranSubmit(e) {
      e.preventDefault();
      const nama = document.getElementById('pelanggaranNama').value.trim();
      const jenis = document.getElementById('pelanggaranJenis').value.trim();
      if (!nama || !jenis) { showToast('Lengkapi field wajib', 'error'); return; }
      const btn = document.getElementById('pelanggaranBtn');
      btn.disabled = true; btn.innerHTML = '<div class="spinner" style="width:20px; height:20px;"></div>';
      const data = {
        namaSantri: nama,
        pelanggaran: jenis,
        keterangan: document.getElementById('pelanggaranKeterangan').value.trim(),
        editor: currentUser?.name
      };
      const res = await callAppsScript('addPelanggaran', { data });
      if (res.success) {
        document.getElementById('pelanggaranForm').reset();
        showToast(res.message, 'success');
        loadPelanggaranData();
      } else showToast(res.message, 'error');
      btn.disabled = false; btn.innerHTML = '<i class="fas fa-save"></i> Simpan Pelanggaran';
    }

    async function loadPelanggaranData() {
      document.getElementById('pelanggaranLoading').classList.add('active');
      const res = await callAppsScript('getPelanggaranData', { filter: {} });
      document.getElementById('pelanggaranLoading').classList.remove('active');
      if (res.success) {
        pelanggaranData = res.data;
        renderPelanggaranTable(pelanggaranData);
      }
    }

    function renderPelanggaranTable(data) {
      const tbody = document.getElementById('pelanggaranTableBody');
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;"><div class="empty-state">Belum ada data pelanggaran</div></td></tr>';
        return;
      }
      tbody.innerHTML = data.map(p => {
        const d = new Date(p.tanggal).toLocaleDateString('id-ID');
        return `<tr>
          <td>${d}</td>
          <td><strong>${p.namaSantri}</strong></td>
          <td><span class="badge badge-danger">${p.pelanggaran}</span></td>
          <td>${p.keterangan || '-'}</td>
          <td>${p.editor}</td>
          <td><div class="action-buttons">
            <button class="action-btn edit" onclick="openEditPelanggaranModal('${p.id}')"><i class="fas fa-edit"></i></button>
            <button class="action-btn delete" onclick="deletePelanggaran('${p.id}')"><i class="fas fa-trash"></i></button>
          </div></td>
        </tr>`;
      }).join('');
    }

    function filterPelanggaran() {
      const kw = document.getElementById('searchPelanggaran').value.toLowerCase();
      const filtered = pelanggaranData.filter(p => p.namaSantri.toLowerCase().includes(kw) || p.pelanggaran.toLowerCase().includes(kw));
      renderPelanggaranTable(filtered);
    }

    function openEditPelanggaranModal(id) {
      const p = pelanggaranData.find(x => x.id === id);
      if (!p) return;
      document.getElementById('editPelanggaranId').value = p.id;
      document.getElementById('editPelanggaranNama').value = p.namaSantri;
      document.getElementById('editPelanggaranJenis').value = p.pelanggaran;
      document.getElementById('editPelanggaranKeterangan').value = p.keterangan || '';
      document.getElementById('editPelanggaranModal').classList.add('active');
    }

    function closeEditPelanggaranModal() { document.getElementById('editPelanggaranModal').classList.remove('active'); }

    async function saveEditPelanggaran() {
      const id = document.getElementById('editPelanggaranId').value;
      const nama = document.getElementById('editPelanggaranNama').value.trim();
      const jenis = document.getElementById('editPelanggaranJenis').value.trim();
      if (!nama || !jenis) { showToast('Lengkapi data', 'error'); return; }
      const data = {
        namaSantri: nama,
        pelanggaran: jenis,
        keterangan: document.getElementById('editPelanggaranKeterangan').value.trim(),
        editor: currentUser?.name
      };
      const res = await callAppsScript('updatePelanggaran', { id, data });
      if (res.success) { closeEditPelanggaranModal(); showToast(res.message, 'success'); loadPelanggaranData(); }
      else showToast(res.message, 'error');
    }

    async function deletePelanggaran(id) {
      if (!confirm('Hapus pelanggaran ini?')) return;
      const res = await callAppsScript('deletePelanggaran', { id });
      if (res.success) { showToast(res.message, 'success'); loadPelanggaranData(); }
      else showToast(res.message, 'error');
    }

    // ========== AUTOCOMPLETE ==========
    function setupAutocomplete(inputId, suggestionsId) {
      const input = document.getElementById(inputId);
      const suggestions = document.getElementById(suggestionsId);
      let selectedIndex = -1;
      if (!input || !suggestions) return;
      input.addEventListener('input', function() {
        const value = this.value.trim();
        if (value.length < 2) { suggestions.classList.remove('active'); return; }
        const matches = santriData.filter(s => s.nama.toLowerCase().includes(value.toLowerCase()));
        if (matches.length === 0) { suggestions.classList.remove('active'); return; }
        suggestions.innerHTML = matches.map(s => `<div class="autocomplete-item" data-nama="${s.nama}">${s.nama}</div>`).join('');
        suggestions.classList.add('active');
        selectedIndex = -1;
      });
      input.addEventListener('keydown', function(e) {
        const items = suggestions.querySelectorAll('.autocomplete-item');
        if (e.key === 'ArrowDown') { e.preventDefault(); selectedIndex = Math.min(selectedIndex + 1, items.length - 1); updateSelection(items); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); selectedIndex = Math.max(selectedIndex - 1, 0); updateSelection(items); }
        else if (e.key === 'Enter' && selectedIndex >= 0) { e.preventDefault(); items[selectedIndex].click(); }
        else if (e.key === 'Escape') { suggestions.classList.remove('active'); }
      });
      suggestions.addEventListener('click', function(e) {
        const item = e.target.closest('.autocomplete-item');
        if (item) { input.value = item.dataset.nama; suggestions.classList.remove('active'); }
      });
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete-wrapper')) suggestions.classList.remove('active');
      });
      function updateSelection(items) { items.forEach((item, idx) => item.classList.toggle('selected', idx === selectedIndex)); }
    }

    // ========== UTILITIES ==========
    function getBulanName(num) {
      const b = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
      return b[num-1] || 'Januari';
    }

    function showToast(msg, type = 'info') {
      const t = document.getElementById('toast');
      t.className = `toast toast-${type} active`;
      t.textContent = msg;
      setTimeout(() => t.classList.remove('active'), 3000);
    }

    function showAlert(elId, msg, type) {
      const a = document.getElementById(elId);
      if (a) { a.className = `alert alert-${type} active`; a.textContent = msg; setTimeout(() => a.classList.remove('active'), 5000); }
    }

    function printAbsensi() { window.print(); }
    function printProgres() { window.print(); }
    function printPelanggaran() { window.print(); }
  </script>
</body>
</html>
