<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sistem Manajemen Santri</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ... SAMA PERSIS dengan style yang ada ... */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    /* Copy semua CSS dari kode asli */
  </style>
</head>
<body>
  <!-- Copy SEMUA HTML body dari kode asli -->
  
  <script>
    // ============================================
    // KONFIGURASI URL GAS
    // ============================================
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyF3shWdyC9dlYgK3V6zzKOpu-WF1BMvra87H7PeySJ6-bKh_G3erp_lvEjCaDy2tDTMw/exec';
    
    // ============================================
    // FUNGSI API UTAMA (GANTI google.script.run)
    // ============================================
    
    async function callGAS(action, params = {}) {
      try {
        const response = await fetch(GAS_URL, {
          method: 'POST',
          mode: 'cors',  // Penting untuk CORS
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ action, ...params })
        });
        
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        
        const result = await response.json();
        return result;
      } catch (error) {
        console.error('API Error:', error);
        return { success: false, message: 'Terjadi kesalahan koneksi' };
      }
    }
    
    // ============================================
    // Global Variables
    // ============================================
    let currentUser = null;
    let santriData = [];
    let kelasData = [];
    let progresData = [];
    let absensiData = [];
    let pelanggaranData = [];
    let editAbsensiStatus = 'H';
    let absensiHariIniData = [];
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      checkLogin();
      setupEventListeners();
      updateTodayDate();
    });
    
    // ============================================
    // AUTHENTICATION (MODIFIKASI)
    // ============================================
    
    async function handleLogin(e) {
      e.preventDefault();
      
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const btn = document.getElementById('loginBtn');
      
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px;"></div>';
      
      const response = await callGAS('login', { username, password });
      
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Masuk';
      
      if (response.success) {
        currentUser = response;
        localStorage.setItem('currentUser', JSON.stringify(response));
        showMainApp();
        showToast('Login berhasil!', 'success');
      } else {
        showAlert('loginAlert', response.message, 'error');
      }
    }
    
    // ============================================
    // DASHBOARD (MODIFIKASI)
    // ============================================
    
    async function loadDashboard() {
      const response = await callGAS('getDashboardStats');
      
      if (response.success) {
        const stats = response.data;
        document.getElementById('statSantri').textContent = stats.totalSantri;
        document.getElementById('statProgres').textContent = stats.totalProgres;
        document.getElementById('statAbsensi').textContent = stats.totalAbsensi;
        document.getElementById('statPelanggaran').textContent = stats.totalPelanggaran;
        
        renderAbsensiHariIni(stats.absensiHariIni);
        renderRecentActivities(stats.recentActivities);
        updateTodayDate();
      } else {
        console.error('Error loading dashboard:', response.message);
        showToast('Error memuat dashboard', 'error');
      }
    }
    
    // ============================================
    // KELAS DATA (MODIFIKASI)
    // ============================================
    
    async function loadKelas() {
      const response = await callGAS('getKelasData');
      if (response.success) {
        kelasData = response.data;
      }
    }
    
    async function loadAbsensiKelasForInput() {
      const response = await callGAS('getKelasData');
      if (response.success) {
        const select = document.getElementById('absensiKelas');
        select.innerHTML = '<option value="">Pilih kelas</option>' + 
          response.data.map(k => `<option value="${k.nama}">${k.nama}</option>`).join('');
      }
    }
    
    async function loadAbsensiKelasForData() {
      const response = await callGAS('getKelasData');
      if (response.success) {
        const select = document.getElementById('viewAbsensiKelas');
        select.innerHTML = '<option value="">Pilih Kelas</option>' + 
          response.data.map(k => `<option value="${k.nama}">${k.nama}</option>`).join('');
      }
    }
    
    async function loadSantriData() {
      const response = await callGAS('getSantriData');
      if (response.success) {
        santriData = response.data;
      }
    }
    
    // ============================================
    // ABSENSI FUNCTIONS (MODIFIKASI)
    // ============================================
    
    async function loadSantriByKelas() {
      const kelas = document.getElementById('absensiKelas').value;
      
      if (!kelas) {
        document.getElementById('absensiSantriList').style.display = 'none';
        return;
      }
      
      const response = await callGAS('getSantriByKelas', { kelas });
      
      if (response.success) {
        const container = document.getElementById('absensiSantriItems');
        document.getElementById('absensiKelasLabel').textContent = kelas;
        
        if (!response.data || response.data.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-text">Tidak ada santri di kelas ini</div>
            </div>
          `;
        } else {
          container.innerHTML = response.data.map(santri => `
            <div style="background: var(--background); padding: 1rem; border-radius: 0.75rem; margin-bottom: 0.75rem;">
              <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;">
                <strong>${santri.nama}</strong>
                <div class="attendance-buttons">
                  <button type="button" class="attendance-btn H active" data-nama="${santri.nama}" data-status="H" onclick="setAttendanceStatus(this)">H</button>
                  <button type="button" class="attendance-btn I" data-nama="${santri.nama}" data-status="I" onclick="setAttendanceStatus(this)">I</button>
                  <button type="button" class="attendance-btn S" data-nama="${santri.nama}" data-status="S" onclick="setAttendanceStatus(this)">S</button>
                  <button type="button" class="attendance-btn A" data-nama="${santri.nama}" data-status="A" onclick="setAttendanceStatus(this)">A</button>
                </div>
              </div>
              <div style="margin-top: 0.5rem;">
                <input type="text" class="form-input" id="keterangan-${santri.nama.replace(/\s+/g, '-')}" placeholder="Keterangan..." style="font-size: 0.875rem;">
              </div>
            </div>
          `).join('');
        }
        
        document.getElementById('absensiSantriList').style.display = 'block';
      }
    }
    
    async function checkAbsensiExists() {
      const tanggal = document.getElementById('absensiTanggal').value;
      const kelas = document.getElementById('absensiKelas').value;
      
      if (!tanggal || !kelas) {
        document.getElementById('absensiExistsWarning').style.display = 'none';
        return;
      }
      
      const dateObj = new Date(tanggal);
      const bulan = getBulanName(dateObj.getMonth() + 1);
      const tanggalNum = dateObj.getDate();
      
      const response = await callGAS('checkAbsensiExists', { kelas, bulan, tanggal: tanggalNum, namaSantri: '' });
      
      if (response.success) {
        document.getElementById('absensiExistsWarning').style.display = response.data.exists ? 'block' : 'none';
      }
    }
    
    async function saveAbsensi() {
      const tanggal = document.getElementById('absensiTanggal').value;
      const kelas = document.getElementById('absensiKelas').value;
      
      if (!tanggal || !kelas) {
        showToast('Mohon pilih tanggal dan kelas', 'error');
        return;
      }
      
      const santriItems = document.querySelectorAll('#absensiSantriItems > div');
      const santriInputData = [];
      
      santriItems.forEach(item => {
        const nama = item.querySelector('strong').textContent;
        const statusBtn = item.querySelector('.attendance-btn.active');
        const status = statusBtn ? statusBtn.dataset.status : 'H';
        const keteranganInput = item.querySelector('input[type="text"]');
        const keterangan = keteranganInput ? keteranganInput.value.trim() : '';
        
        santriInputData.push({
          nama: nama,
          status: status,
          keterangan: keterangan
        });
      });
      
      if (santriInputData.length === 0) {
        showToast('Tidak ada data santri untuk disimpan', 'error');
        return;
      }
      
      const data = {
        tanggal: tanggal,
        kelas: kelas,
        santri: santriInputData,
        editor: currentUser.name
      };
      
      const response = await callGAS('addAbsensi', { data });
      
      if (response.success) {
        showToast(response.message, 'success');
        document.getElementById('absensiSantriItems').innerHTML = '';
        document.getElementById('absensiSantriList').style.display = 'none';
        loadDashboard();
        
        const viewKelas = document.getElementById('viewAbsensiKelas').value;
        const viewBulan = document.getElementById('viewAbsensiBulan').value;
        if (viewKelas === kelas) {
          const dateObj = new Date(tanggal);
          const bulan = getBulanName(dateObj.getMonth() + 1);
          if (viewBulan === bulan) {
            loadAbsensiView();
          }
        }
      } else {
        showToast(response.message, 'error');
      }
    }
    
    async function loadAbsensiBulanList() {
      const kelas = document.getElementById('viewAbsensiKelas').value;
      
      if (!kelas) {
        document.getElementById('viewAbsensiBulan').innerHTML = '<option value="">Pilih Bulan</option>';
        return;
      }
      
      document.getElementById('absensiViewLoading').classList.add('active');
      
      const response = await callGAS('getAbsensiBulan', { kelas });
      
      document.getElementById('absensiViewLoading').classList.remove('active');
      
      if (response.success) {
        const select = document.getElementById('viewAbsensiBulan');
        select.innerHTML = '<option value="">Pilih Bulan</option>' + 
          response.data.map(b => `<option value="${b.nama}">${b.nama}</option>`).join('');
      } else {
        showToast('Error memuat daftar bulan', 'error');
      }
    }
    
    async function loadAbsensiView() {
      const kelas = document.getElementById('viewAbsensiKelas').value;
      const bulan = document.getElementById('viewAbsensiBulan').value;
      
      if (!kelas || !bulan) {
        return;
      }
      
      document.getElementById('absensiViewLoading').classList.add('active');
      
      const response = await callGAS('getAbsensiData', { filter: { kelas, bulan } });
      
      document.getElementById('absensiViewLoading').classList.remove('active');
      
      if (response.success) {
        renderAbsensiTable(response.data, bulan);
      } else {
        showToast('Error memuat data absensi', 'error');
      }
    }
    
    async function saveEditAbsensi() {
      const kelas = document.getElementById('editAbsensiKelas').value;
      const bulan = document.getElementById('editAbsensiBulan').value;
      const tanggal = document.getElementById('editAbsensiTanggal').value;
      const namaSantri = document.getElementById('editAbsensiNamaSantri').value;
      
      const data = {
        kelas: kelas,
        bulan: bulan,
        tanggal: tanggal,
        namaSantri: namaSantri,
        status: editAbsensiStatus
      };
      
      const response = await callGAS('updateAbsensi', { id: '', data });
      
      if (response.success) {
        closeEditAbsensiModal();
        showToast(response.message, 'success');
        loadAbsensiView();
      } else {
        showToast(response.message, 'error');
      }
    }
    
    async function deleteAbsensiCell() {
      if (!confirm('Apakah Anda yakin ingin menghapus absensi ini?')) return;
      
      const kelas = document.getElementById('editAbsensiKelas').value;
      const bulan = document.getElementById('editAbsensiBulan').value;
      const tanggal = document.getElementById('editAbsensiTanggal').value;
      const namaSantri = document.getElementById('editAbsensiNamaSantri').value;
      
      const data = {
        kelas: kelas,
        bulan: bulan,
        tanggal: tanggal,
        namaSantri: namaSantri
      };
      
      const response = await callGAS('deleteAbsensi', { data });
      
      if (response.success) {
        closeEditAbsensiModal();
        showToast(response.message, 'success');
        loadAbsensiView();
      } else {
        showToast(response.message, 'error');
      }
    }
    
    // ============================================
    // PROGRES FUNCTIONS (MODIFIKASI)
    // ============================================
    
    async function handleProgresSubmit(e) {
      e.preventDefault();
      
      const namaSantri = document.getElementById('progresNama').value.trim();
      const tipeHafalan = document.getElementById('progresTipe').value;
      
      if (!namaSantri || !tipeHafalan) {
        showAlert('progresAlert', 'Mohon lengkapi semua field yang wajib diisi', 'error');
        return;
      }
      
      const btn = document.getElementById('progresBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px;"></div>';
      
      let data = {
        namaSantri: namaSantri,
        tipeHafalan: tipeHafalan,
        keterangan: document.getElementById('progresKeterangan').value.trim(),
        editor: currentUser.name
      };
      
      if (tipeHafalan === 'Surat Wajib') {
        data.surah = document.getElementById('progresSurah').value.trim();
        data.dariAyat = document.getElementById('progresDariAyat').value;
        data.sampaiAyat = document.getElementById('progresSampaiAyat').value;
      } else if (tipeHafalan === 'Kitab') {
        data.surah = document.getElementById('progresNamaKitab').value.trim();
        data.bait = document.getElementById('progresBait').value;
      } else if (tipeHafalan === 'Lainnya') {
        data.surah = document.getElementById('progresNamaLainnya').value.trim();
      } else {
        data.surah = '-';
      }
      
      const response = await callGAS('addProgres', { data });
      
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save"></i> Simpan Progres';
      
      if (response.success) {
        document.getElementById('progresForm').reset();
        handleProgresTipeChange();
        showToast(response.message, 'success');
        loadProgresData();
      } else {
        showToast(response.message, 'error');
      }
    }
    
    async function loadProgresData() {
      document.getElementById('progresLoading').classList.add('active');
      
      const response = await callGAS('getProgresData', { filter: {} });
      
      document.getElementById('progresLoading').classList.remove('active');
      
      if (response.success) {
        progresData = response.data;
        renderProgresTable(response.data);
      } else {
        showToast('Error memuat data progres', 'error');
      }
    }
    
    async function saveEditProgres() {
      const id = document.getElementById('editProgresId').value;
      const namaSantri = document.getElementById('editProgresNama').value.trim();
      const tipeHafalan = document.getElementById('editProgresTipe').value;
      
      if (!namaSantri || !tipeHafalan) {
        showToast('Mohon lengkapi semua field yang wajib diisi', 'error');
        return;
      }
      
      let data = {
        namaSantri: namaSantri,
        tipeHafalan: tipeHafalan,
        keterangan: document.getElementById('editProgresKeterangan').value.trim(),
        editor: currentUser.name
      };
      
      if (tipeHafalan === 'Surat Wajib') {
        data.surah = document.getElementById('editProgresSurah').value.trim();
        data.dariAyat = document.getElementById('editProgresDariAyat').value;
        data.sampaiAyat = document.getElementById('editProgresSampaiAyat').value;
      } else if (tipeHafalan === 'Kitab') {
        data.surah = document.getElementById('editProgresNamaKitab').value.trim();
        data.bait = document.getElementById('editProgresBait').value;
      } else if (tipeHafalan === 'Lainnya') {
        data.surah = document.getElementById('editProgresNamaLainnya').value.trim();
      } else {
        data.surah = '-';
      }
      
      const response = await callGAS('updateProgres', { id, data });
      
      if (response.success) {
        closeEditProgresModal();
        showToast(response.message, 'success');
        loadProgresData();
      } else {
        showToast(response.message, 'error');
      }
    }
    
    async function deleteProgres(id) {
      if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) return;
      
      const response = await callGAS('deleteProgres', { id });
      
      if (response.success) {
        showToast(response.message, 'success');
        loadProgresData();
      } else {
        showToast(response.message, 'error');
      }
    }
    
    // ============================================
    // PELANGGARAN FUNCTIONS (MODIFIKASI)
    // ============================================
    
    async function handlePelanggaranSubmit(e) {
      e.preventDefault();
      
      const namaSantri = document.getElementById('pelanggaranNama').value.trim();
      const pelanggaran = document.getElementById('pelanggaranJenis').value.trim();
      
      if (!namaSantri || !pelanggaran) {
        showAlert('pelanggaranAlert', 'Mohon lengkapi semua field yang wajib diisi', 'error');
        return;
      }
      
      const btn = document.getElementById('pelanggaranBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px;"></div>';
      
      const data = {
        namaSantri: namaSantri,
        pelanggaran: pelanggaran,
        keterangan: document.getElementById('pelanggaranKeterangan').value.trim(),
        editor: currentUser.name
      };
      
      const response = await callGAS('addPelanggaran', { data });
      
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save"></i> Simpan Pelanggaran';
      
      if (response.success) {
        document.getElementById('pelanggaranForm').reset();
        showToast(response.message, 'success');
        loadPelanggaranData();
      } else {
        showToast(response.message, 'error');
      }
    }
    
    async function loadPelanggaranData() {
      document.getElementById('pelanggaranLoading').classList.add('active');
      
      const response = await callGAS('getPelanggaranData', { filter: {} });
      
      document.getElementById('pelanggaranLoading').classList.remove('active');
      
      if (response.success) {
        pelanggaranData = response.data;
        renderPelanggaranTable(response.data);
      } else {
        showToast('Error memuat data pelanggaran', 'error');
      }
    }
    
    async function saveEditPelanggaran() {
      const id = document.getElementById('editPelanggaranId').value;
      const namaSantri = document.getElementById('editPelanggaranNama').value.trim();
      const pelanggaran = document.getElementById('editPelanggaranJenis').value.trim();
      
      if (!namaSantri || !pelanggaran) {
        showToast('Mohon lengkapi semua field yang wajib diisi', 'error');
        return;
      }
      
      const data = {
        namaSantri: namaSantri,
        pelanggaran: pelanggaran,
        keterangan: document.getElementById('editPelanggaranKeterangan').value.trim(),
        editor: currentUser.name
      };
      
      const response = await callGAS('updatePelanggaran', { id, data });
      
      if (response.success) {
        closeEditPelanggaranModal();
        showToast(response.message, 'success');
        loadPelanggaranData();
      } else {
        showToast(response.message, 'error');
      }
    }
    
    async function deletePelanggaran(id) {
      if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) return;
      
      const response = await callGAS('deletePelanggaran', { id });
      
      if (response.success) {
        showToast(response.message, 'success');
        loadPelanggaranData();
      } else {
        showToast(response.message, 'error');
      }
    }
    
    // ============================================
    // FUNGSI-FUNGSI LAINNYA (SAMA PERSIS)
    // ============================================
    
    function updateTodayDate() {
      const today = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('todayDate').textContent = today.toLocaleDateString('id-ID', options);
    }
    
    function setupEventListeners() {
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      document.getElementById('progresForm').addEventListener('submit', handleProgresSubmit);
      document.getElementById('pelanggaranForm').addEventListener('submit', handlePelanggaranSubmit);
      
      setupAutocomplete('progresNama', 'progresNamaSuggestions');
      setupAutocomplete('pelanggaranNama', 'pelanggaranNamaSuggestions');
      setupAutocomplete('editProgresNama', 'editProgresNamaSuggestions');
      setupAutocomplete('editPelanggaranNama', 'editPelanggaranNamaSuggestions');
      
      document.getElementById('absensiTanggal').valueAsDate = new Date();
      setupNavigation();
    }
    
    function setupNavigation() {
      const navTabs = document.querySelector('.nav-tabs');
      if (navTabs) {
        navTabs.addEventListener('click', function(e) {
          const tab = e.target.closest('.nav-tab');
          if (!tab) return;
          
          e.preventDefault();
          
          let page = 'dashboard';
          const tabText = tab.textContent.trim().toLowerCase();
          
          if (tabText.includes('absensi') && !tabText.includes('data')) {
            page = 'absensi';
          } else if (tabText.includes('data absensi') || tabText.includes('data-absensi')) {
            page = 'dataAbsensi';
          } else if (tabText.includes('progres')) {
            page = 'progres';
          } else if (tabText.includes('pelanggaran')) {
            page = 'pelanggaran';
          }
          
          showPage(page, e);
        });
      }
    }
    
    function checkLogin() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainApp();
      }
    }
    
    function logout() {
      localStorage.removeItem('currentUser');
      currentUser = null;
      document.getElementById('mainApp').classList.remove('active');
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
      showToast('Logout berhasil', 'info');
    }
    
    function showMainApp() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('mainApp').classList.add('active');
      
      document.getElementById('userName').textContent = currentUser.name || 'Administrator';
      document.getElementById('userAvatar').textContent = (currentUser.name || 'A').charAt(0).toUpperCase();
      
      showPage('dashboard');
      
      loadKelas();
      loadSantriData();
    }
    
    function showPage(page, event = null) {
      document.querySelectorAll('.page').forEach(p => {
        if (p && p.style) {
          p.style.display = 'none';
        }
      });
      
      document.querySelectorAll('.nav-tabs .nav-tab').forEach(t => {
        if (t) {
          t.classList.remove('active');
        }
      });
      
      let pageElementId = page + 'Page';
      
      if (page === 'data-absensi') {
        pageElementId = 'dataAbsensiPage';
      }
      
      const pageElement = document.getElementById(pageElementId);
      if (pageElement && pageElement.style) {
        pageElement.style.display = 'block';
      } else {
        const dashboardElement = document.getElementById('dashboardPage');
        if (dashboardElement && dashboardElement.style) {
          dashboardElement.style.display = 'block';
          page = 'dashboard';
        }
      }
      
      if (event && event.target) {
        const tab = event.target.closest('.nav-tab');
        if (tab) {
          tab.classList.add('active');
        }
      } else {
        const tabs = document.querySelectorAll('.nav-tab');
        tabs.forEach(tab => {
          if (tab.textContent.toLowerCase().includes(page.replace('-', ' ').toLowerCase())) {
            tab.classList.add('active');
          }
        });
      }
      
      if (page === 'dashboard') {
        loadDashboard();
      } else if (page === 'absensi') {
        loadAbsensiKelasForInput();
      } else if (page === 'data-absensi' || page === 'dataAbsensi') {
        loadAbsensiKelasForData();
      } else if (page === 'progres') {
        loadProgresData();
      } else if (page === 'pelanggaran') {
        loadPelanggaranData();
      }
    }
    
    function renderAbsensiHariIni(absensiList) {
      const tbody = document.getElementById('absensiHariIniBody');
      absensiHariIniData = absensiList || [];
      
      if (!absensiList || absensiList.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center;">
              <div style="padding: 2rem; color: var(--text-secondary);">
                <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--success);"></i>
                <div>Semua santri hadir hari ini</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = absensiList.map(item => {
        let badgeClass = 'badge-success';
        let statusLabel = 'Hadir';
        
        if (item.status === 'I') {
          badgeClass = 'badge-info';
          statusLabel = 'Izin';
        } else if (item.status === 'S') {
          badgeClass = 'badge-warning';
          statusLabel = 'Sakit';
        } else if (item.status === 'A') {
          badgeClass = 'badge-danger';
          statusLabel = 'Alpa';
        }
        
        return `
          <tr>
            <td><strong>${item.namaSantri}</strong></td>
            <td>${item.kelas}</td>
            <td><span class="badge ${badgeClass}">${statusLabel}</span></td>
            <td>${item.keterangan || '-'}</td>
          </tr>
        `;
      }).join('');
    }
    
    function renderRecentActivities(activities) {
      const container = document.getElementById('recentActivities');
      
      if (!activities || activities.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"><i class="fas fa-history"></i></div>
            <div class="empty-state-text">Belum ada aktivitas</div>
            <div class="empty-state-subtext">Mulai input data untuk melihat aktivitas terbaru</div>
          </div>
        `;
        return;
      }
      
      let html = '<div class="table-responsive"><table class="data-table"><tbody>';
      
      activities.forEach(activity => {
        const date = new Date(activity.tanggal).toLocaleDateString('id-ID', {
          day: 'numeric',
          month: 'short',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        let icon, badge, label, detail;
        
        if (activity.type === 'absensi') {
          icon = 'fa-calendar-check';
          badge = 'badge-info';
          label = 'Absensi';
          detail = activity.kelas;
        } else if (activity.type === 'progres') {
          icon = 'fa-book-quran';
          badge = 'badge-success';
          label = 'Progres';
          detail = activity.tipeHafalan;
        } else {
          icon = 'fa-exclamation-triangle';
          badge = 'badge-danger';
          label = 'Pelanggaran';
          detail = activity.pelanggaran;
        }
        
        html += `
          <tr>
            <td>
              <span class="badge ${badge}">${label}</span>
            </td>
            <td><strong>${activity.namaSantri}</strong></td>
            <td>${detail}</td>
            <td><small>${date}</small></td>
          </tr>
        `;
      });
      
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }
    
    function setupAutocomplete(inputId, suggestionsId) {
      const input = document.getElementById(inputId);
      const suggestions = document.getElementById(suggestionsId);
      let selectedIndex = -1;
      
      if (!input || !suggestions) return;
      
      input.addEventListener('input', function() {
        const value = this.value.trim();
        
        if (value.length < 2) {
          suggestions.classList.remove('active');
          return;
        }
        
        const matches = santriData.filter(s => 
          s.nama.toLowerCase().includes(value.toLowerCase())
        );
        
        if (matches.length === 0) {
          suggestions.classList.remove('active');
          return;
        }
        
        suggestions.innerHTML = matches.map(s => 
          `<div class="autocomplete-item" data-nama="${s.nama}">${s.nama}</div>`
        ).join('');
        
        suggestions.classList.add('active');
        selectedIndex = -1;
      });
      
      input.addEventListener('keydown', function(e) {
        const items = suggestions.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
          updateSelection(items);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, 0);
          updateSelection(items);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
          e.preventDefault();
          items[selectedIndex].click();
        } else if (e.key === 'Escape') {
          suggestions.classList.remove('active');
        }
      });
      
      suggestions.addEventListener('click', function(e) {
        const item = e.target.closest('.autocomplete-item');
        if (item) {
          input.value = item.dataset.nama;
          suggestions.classList.remove('active');
        }
      });
      
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete-wrapper')) {
          suggestions.classList.remove('active');
        }
      });
      
      function updateSelection(items) {
        items.forEach((item, index) => {
          item.classList.toggle('selected', index === selectedIndex);
        });
      }
    }
    
    function setAttendanceStatus(btn) {
      const nama = btn.dataset.nama;
      
      document.querySelectorAll(`.attendance-buttons button[data-nama="${nama}"]`).forEach(b => {
        b.classList.remove('active');
      });
      
      btn.classList.add('active');
    }
    
    function renderAbsensiTable(data, bulan) {
      const thead = document.getElementById('absensiTableHead');
      const tbody = document.getElementById('absensiTableBody');
      
      if (!data || data.length === 0) {
        thead.innerHTML = '';
        tbody.innerHTML = `
          <tr>
            <td colspan="33" style="text-align: center;">
              <div class="empty-state">
                <div class="empty-state-text">Belum ada data absensi</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      let headerHtml = '<tr><th rowspan="2" style="text-align: left;">Nama Santri</th><th colspan="31" style="text-align: center;">Tanggal</th><th rowspan="2">Keterangan</th></tr>';
      headerHtml += '<tr>';
      for (let i = 1; i <= 31; i++) {
        headerHtml += `<th class="status-cell">${i}</th>`;
      }
      headerHtml += '<th>&nbsp;</th></tr>';
      thead.innerHTML = headerHtml;
      
      let bodyHtml = '';
      data.forEach(item => {
        bodyHtml += '<tr>';
        bodyHtml += `<th class="nama-cell">${item.namaSantri}</th>`;
        
        for (let i = 1; i <= 31; i++) {
          const status = item.tanggal[i] || '';
          bodyHtml += `<td class="status-cell" onclick="openEditAbsensiModal('${item.namaSantri}', ${i}, '${status}')" style="cursor: pointer;">`;
          if (status) {
            bodyHtml += `<span class="status-badge ${status}">${status}</span>`;
          } else {
            bodyHtml += `<span class="status-badge empty">-</span>`;
          }
          bodyHtml += '</td>';
        }
        
        bodyHtml += `<td class="keterangan-cell">${item.keterangan || '-'}</td>`;
        bodyHtml += '</tr>';
      });
      
      tbody.innerHTML = bodyHtml;
    }
    
    function openEditAbsensiModal(namaSantri, tanggal, status) {
      document.getElementById('editAbsensiNamaSantri').value = namaSantri;
      document.getElementById('editAbsensiNamaDisplay').value = namaSantri;
      document.getElementById('editAbsensiKelas').value = document.getElementById('viewAbsensiKelas').value;
      document.getElementById('editAbsensiBulan').value = document.getElementById('viewAbsensiBulan').value;
      document.getElementById('editAbsensiTanggal').value = tanggal;
      
      const bulan = document.getElementById('editAbsensiBulan').value;
      document.getElementById('editAbsensiTanggalDisplay').value = `${tanggal} ${bulan}`;
      
      setEditAbsensiStatus(status || 'H');
      
      document.getElementById('editAbsensiModal').classList.add('active');
    }
    
    function closeEditAbsensiModal() {
      document.getElementById('editAbsensiModal').classList.remove('active');
    }
    
    function setEditAbsensiStatus(status) {
      editAbsensiStatus = status;
      
      document.getElementById('editAbsensiBtnH').classList.remove('active');
      document.getElementById('editAbsensiBtnI').classList.remove('active');
      document.getElementById('editAbsensiBtnS').classList.remove('active');
      document.getElementById('editAbsensiBtnA').classList.remove('active');
      
      document.getElementById('editAbsensiBtn' + status).classList.add('active');
    }
    
    function printAbsensi() {
      const kelas = document.getElementById('viewAbsensiKelas').value;
      const bulan = document.getElementById('viewAbsensiBulan').value;
      const printContent = document.getElementById('absensiTable').outerHTML;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Laporan Absensi - ${kelas} ${bulan}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 8pt; }
            th, td { border: 1px solid #ddd; padding: 4px; text-align: center; }
            th { background-color: #059669; color: white; font-size: 9pt; }
            .nama-cell { text-align: left; font-weight: 600; }
            .keterangan-cell { text-align: left; font-size: 7pt; white-space: pre-wrap; }
            h1 { color: #059669; text-align: center; }
            @media print { body { padding: 0; } }
          </style>
        </head>
        <body>
          <h1>Laporan Absensi - ${kelas} ${bulan}</h1>
          ${printContent}
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }
    
    function getBulanName(bulanNum) {
      const bulanList = [
        'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
      ];
      return bulanList[bulanNum - 1] || 'Januari';
    }
    
    function handleProgresTipeChange() {
      const tipe = document.getElementById('progresTipe').value;
      
      document.getElementById('suratWajibFields').style.display = 'none';
      document.getElementById('kitabFields').style.display = 'none';
      document.getElementById('lainnyaFields').style.display = 'none';
      
      if (tipe === 'Surat Wajib') {
        document.getElementById('suratWajibFields').style.display = 'block';
      } else if (tipe === 'Kitab') {
        document.getElementById('kitabFields').style.display = 'block';
      } else if (tipe === 'Lainnya') {
        document.getElementById('lainnyaFields').style.display = 'block';
      }
    }
    
    function renderProgresTable(data) {
      const tbody = document.getElementById('progresTableBody');
      
      if (!data || data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center;">
              <div class="empty-state">
                <div class="empty-state-text">Belum ada data progres</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = data.map(item => {
        const date = new Date(item.tanggal).toLocaleDateString('id-ID');
        let detail = '';
        
        if (item.tipeHafalan === 'Surat Wajib') {
          detail = `${item.surah} (${item.dariAyat || 0} - ${item.sampaiAyat || 0})`;
        } else if (item.tipeHafalan === 'Kitab') {
          detail = `${item.surah} (${item.bait || 0} bait)`;
        } else {
          detail = item.surah || '-';
        }
        
        return `
          <tr>
            <td>${date}</td>
            <td><strong>${item.namaSantri}</strong></td>
            <td><span class="badge badge-info">${item.tipeHafalan}</span></td>
            <td>${detail}</td>
            <td>${item.editor}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn edit" onclick="openEditProgresModal('${item.id}')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete" onclick="deleteProgres('${item.id}')" title="Hapus">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function filterProgres() {
      const keyword = document.getElementById('searchProgres').value.toLowerCase();
      const filtered = progresData.filter(item => 
        item.namaSantri.toLowerCase().includes(keyword) ||
        item.tipeHafalan.toLowerCase().includes(keyword)
      );
      renderProgresTable(filtered);
    }
    
    function openEditProgresModal(id) {
      const item = progresData.find(p => p.id === id);
      if (!item) return;
      
      document.getElementById('editProgresId').value = id;
      document.getElementById('editProgresNama').value = item.namaSantri;
      document.getElementById('editProgresTipe').value = item.tipeHafalan;
      document.getElementById('editProgresKeterangan').value = item.keterangan || '';
      
      handleEditProgresTipeChange();
      
      if (item.tipeHafalan === 'Surat Wajib') {
        document.getElementById('editProgresSurah').value = item.surah || '';
        document.getElementById('editProgresDariAyat').value = item.dariAyat || '';
        document.getElementById('editProgresSampaiAyat').value = item.sampaiAyat || '';
      } else if (item.tipeHafalan === 'Kitab') {
        document.getElementById('editProgresNamaKitab').value = item.surah || '';
        document.getElementById('editProgresBait').value = item.bait || '';
      } else {
        document.getElementById('editProgresNamaLainnya').value = item.surah || '';
      }
      
      document.getElementById('editProgresModal').classList.add('active');
    }
    
    function closeEditProgresModal() {
      document.getElementById('editProgresModal').classList.remove('active');
    }
    
    function handleEditProgresTipeChange() {
      const tipe = document.getElementById('editProgresTipe').value;
      
      document.getElementById('editSuratWajibFields').style.display = 'none';
      document.getElementById('editKitabFields').style.display = 'none';
      document.getElementById('editLainnyaFields').style.display = 'none';
      
      if (tipe === 'Surat Wajib') {
        document.getElementById('editSuratWajibFields').style.display = 'block';
      } else if (tipe === 'Kitab') {
        document.getElementById('editKitabFields').style.display = 'block';
      } else if (tipe === 'Lainnya') {
        document.getElementById('editLainnyaFields').style.display = 'block';
      }
    }
    
    function printProgres() {
      const printContent = document.getElementById('progresTable').outerHTML;
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Laporan Progres Hafalan</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #4CAF50; color: white; }
            h1 { color: #4CAF50; }
          </style>
        </head>
        <body>
          <h1>Laporan Progres Hafalan</h1>
          ${printContent}
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }
    
    function renderPelanggaranTable(data) {
      const tbody = document.getElementById('pelanggaranTableBody');
      
      if (!data || data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center;">
              <div class="empty-state">
                <div class="empty-state-text">Belum ada data pelanggaran</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = data.map(item => {
        const date = new Date(item.tanggal).toLocaleDateString('id-ID');
        
        return `
          <tr>
            <td>${date}</td>
            <td><strong>${item.namaSantri}</strong></td>
            <td><span class="badge badge-danger">${item.pelanggaran}</span></td>
            <td>${item.keterangan || '-'}</td>
            <td>${item.editor}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn edit" onclick="openEditPelanggaranModal('${item.id}')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete" onclick="deletePelanggaran('${item.id}')" title="Hapus">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function filterPelanggaran() {
      const keyword = document.getElementById('searchPelanggaran').value.toLowerCase();
      const filtered = pelanggaranData.filter(item => 
        item.namaSantri.toLowerCase().includes(keyword) ||
        item.pelanggaran.toLowerCase().includes(keyword)
      );
      renderPelanggaranTable(filtered);
    }
    
    function openEditPelanggaranModal(id) {
      const item = pelanggaranData.find(p => p.id === id);
      if (!item) return;
      
      document.getElementById('editPelanggaranId').value = id;
      document.getElementById('editPelanggaranNama').value = item.namaSantri;
      document.getElementById('editPelanggaranJenis').value = item.pelanggaran;
      document.getElementById('editPelanggaranKeterangan').value = item.keterangan || '';
      
      document.getElementById('editPelanggaranModal').classList.add('active');
    }
    
    function closeEditPelanggaranModal() {
      document.getElementById('editPelanggaranModal').classList.remove('active');
    }
    
    function printPelanggaran() {
      const printContent = document.getElementById('pelanggaranTable').outerHTML;
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Laporan Pelanggaran</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f44336; color: white; }
            h1 { color: #f44336; }
          </style>
        </head>
        <body>
          <h1>Laporan Pelanggaran</h1>
          ${printContent}
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }
    
    function showAlert(elementId, message, type) {
      const alert = document.getElementById(elementId);
      if (alert) {
        alert.className = `alert alert-${type} active`;
        alert.textContent = message;
        
        setTimeout(() => {
          alert.classList.remove('active');
        }, 5000);
      }
    }
    
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      if (toast) {
        toast.className = `toast toast-${type} active`;
        toast.textContent = message;
        
        setTimeout(() => {
          toast.classList.remove('active');
        }, 3000);
      }
    }
  </script>
</body>
</html>
