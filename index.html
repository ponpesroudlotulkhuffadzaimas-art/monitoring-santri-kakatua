<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sistem Manajemen Santri - Digital Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* CSS ANDA TETAP SAMA (PERSIS SEPERTI DI APPS SCRIPT) */
    /* ... (Gunakan semua CSS dari <style> yang Anda tempelkan di atas) ... */
    /* Saya tambahkan sedikit untuk animasi tab */
    .page { display: none; animation: fadeIn 0.3s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    /* Tambahan agar scroll halus di HP */
    body { -webkit-overflow-scrolling: touch; }
    .nav-tabs { sticky: top; z-index: 10; }
  </style>
</head>
<body>

  <div class="login-page" id="loginPage">
    <div class="login-card">
      <div class="login-logo"><i class="fas fa-mosque"></i></div>
      <h1 class="login-title">Sistem Manajemen Santri</h1>
      <p class="login-subtitle">Masuk untuk melanjutkan</p>
      <div id="loginAlert" class="alert"></div>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label">Username</label>
          <input type="text" class="form-input" id="loginUsername" placeholder="admin" required>
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="loginPassword" placeholder="••••••••" required>
        </div>
        <button type="submit" class="btn btn-primary" id="loginBtn">
          <i class="fas fa-sign-in-alt"></i> Masuk
        </button>
      </form>
    </div>
  </div>

  <div class="main-app" id="mainApp" style="display: none;">
    <div class="app-container">
      <header class="app-header">
        <div class="app-header-left">
          <div class="app-title"><i class="fas fa-mosque" style="color: var(--primary);"></i> Sistem Santri</div>
          <div class="app-subtitle">Manajemen Hafalan & Pelanggaran</div>
        </div>
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">A</div>
          <div>
            <div style="font-weight: 600;" id="userName">Administrator</div>
            <div style="font-size: 0.75rem; color: var(--text-secondary);">Online</div>
          </div>
          <button class="action-btn delete" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
        </div>
      </header>

      <nav class="nav-tabs">
        <button class="nav-tab active" onclick="showPage('dashboard')"><i class="fas fa-home"></i> Dashboard</button>
        <button class="nav-tab" onclick="showPage('absensi')"><i class="fas fa-clipboard-check"></i> Absensi</button>
        <button class="nav-tab" onclick="showPage('progres')"><i class="fas fa-book-quran"></i> Progres</button>
        <button class="nav-tab" onclick="showPage('pelanggaran')"><i class="fas fa-exclamation-circle"></i> Disiplin</button>
      </nav>

      <section class="page active" id="dashboardPage">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon primary"><i class="fas fa-users"></i></div>
            <div class="stat-value" id="statSantri">0</div>
            <div class="stat-label">Santri</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon success"><i class="fas fa-book-quran"></i></div>
            <div class="stat-value" id="statProgres">0</div>
            <div class="stat-label">Hafalan</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon danger"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="stat-value" id="statPelanggaran">0</div>
            <div class="stat-label">Pelanggaran</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h2 class="card-title"><i class="fas fa-history"></i> Aktivitas Terbaru</h2></div>
          <div id="recentActivities"><div class="loading active"><div class="spinner"></div></div></div>
        </div>
      </section>

      <section class="page" id="progresPage">
        <div class="card">
          <div class="card-header"><h2 class="card-title"><i class="fas fa-plus-circle"></i> Input Progres</h2></div>
          <form id="progresForm">
            <div class="form-group">
              <label class="form-label">Nama Santri *</label>
              <div class="autocomplete-wrapper">
                <input type="text" class="form-input" id="progresNama" placeholder="Cari nama..." required onkeyup="handleAutocomplete(this)">
                <div class="autocomplete-suggestions" id="suggestions"></div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Tipe Hafalan *</label>
              <select class="form-select" id="progresTipe" required>
                <option value="Surat Wajib">Surat Wajib</option>
                <option value="Kitab">Kitab</option>
                <option value="Fasholatan">Fasholatan</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Keterangan (Surah/Ayat/Halaman)</label>
              <textarea class="form-textarea" id="progresKet" placeholder="Contoh: Al-Baqarah 1-10"></textarea>
            </div>
            <button type="submit" class="btn btn-primary" id="saveProgresBtn">Simpan Data</button>
          </form>
        </div>
      </section>

      <section class="page" id="absensiPage">
        <div class="card">
          <div class="card-header"><h2 class="card-title"><i class="fas fa-calendar-check"></i> Absensi Kelas</h2></div>
          <div class="form-group">
            <label class="form-label">Pilih Kelas</label>
            <select class="form-select" id="absensiKelas" onchange="loadDaftarSantriAbsen()">
              <option value="">-- Pilih --</option>
              <option value="TAHFIDZ_PUTRA">Tahfidz Putra</option>
              <option value="TAHFIDZ_PUTRI">Tahfidz Putri</option>
              <option value="MADIN_1">Madin 1</option>
            </select>
          </div>
          <div id="listSantriAbsen" class="space-y-2"></div>
        </div>
      </section>

    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxU9GN2yQ0d-etzODIO8fy5NRx0H3WND-hXmtKoPsrtgm63FkDuP8iyp4_UO1BoKyZB0A/exec";
    let allSantri = [];

    // --- SISTEM LOGIN ---
    document.getElementById('loginForm').onsubmit = function(e) {
      e.preventDefault();
      const u = document.getElementById('loginUsername').value;
      const p = document.getElementById('loginPassword').value;
      
      // Sesuai default Anda
      if(u === 'admin' && p === 'santri123') {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        initApp();
      } else {
        alert('Login Gagal!');
      }
    };

    function logout() { location.reload(); }

    // --- NAVIGATION ---
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.getElementById(pageId + 'Page').classList.add('active');
      event.currentTarget.classList.add('active');
    }

    // --- LOAD DATA AWAL ---
    async function initApp() {
      fetch(`${SCRIPT_URL}?action=getDashboard`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('statSantri').innerText = data.totalSantri;
          document.getElementById('statProgres').innerText = data.totalProgres;
          document.getElementById('statPelanggaran').innerText = data.totalPelanggaran;
          renderActivities(data.recentActivities);
        });

      // Load data santri untuk autocomplete
      fetch(`${SCRIPT_URL}?action=getSantri`)
        .then(res => res.json())
        .then(data => { allSantri = data; });
    }

    // --- AUTOCOMPLETE LOGIC ---
    function handleAutocomplete(input) {
      const val = input.value.toLowerCase();
      const sugBox = document.getElementById('suggestions');
      sugBox.innerHTML = '';
      if(val.length < 2) return;

      const matches = allSantri.filter(s => s.nama.toLowerCase().includes(val));
      matches.forEach(m => {
        const div = document.createElement('div');
        div.className = 'autocomplete-item';
        div.innerText = `${m.nama} (${m.kelas})`;
        div.onclick = () => {
          input.value = m.nama;
          sugBox.classList.remove('active');
        };
        sugBox.appendChild(div);
      });
      sugBox.classList.add('active');
    }

    // --- RENDER TIMELINE ---
    function renderActivities(acts) {
      const container = document.getElementById('recentActivities');
      let html = '';
      acts.forEach(a => {
        html += `
          <div style="padding: 10px; border-bottom: 1px solid #eee; font-size: 0.85rem;">
            <strong>${a.namaSantri}</strong> 
            <span class="badge ${a.type==='progres'?'badge-success':'badge-danger'}">${a.type}</span>
            <div style="color: #666; font-size: 0.75rem;">${a.status || a.tipeHafalan} - ${new Date(a.tanggal).toLocaleDateString()}</div>
          </div>
        `;
      });
      container.innerHTML = html || '<p class="empty-state">Tidak ada aktivitas</p>';
    }

    // --- FORM SUBMIT (PROGRES) ---
    document.getElementById('progresForm').onsubmit = async function(e) {
      e.preventDefault();
      const btn = document.getElementById('saveProgresBtn');
      btn.disabled = true; btn.innerText = "Menyimpan...";

      const payload = {
        action: 'addProgres',
        namaSantri: document.getElementById('progresNama').value,
        tipeHafalan: document.getElementById('progresTipe').value,
        keterangan: document.getElementById('progresKet').value
      };

      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors', // Penting untuk Apps Script
          body: JSON.stringify(payload)
        });
        alert('Data Berhasil Terkirim!');
        this.reset();
      } catch (e) {
        alert('Error simpan data');
      } finally {
        btn.disabled = false; btn.innerText = "Simpan Data";
      }
    };
  </script>
</body>
</html>
